**AWS IoT: Real-Time Device Data to AWS IoT Core**

**Objective:** By the end of this session, participants will understand 
1. Introduction to AWS IoT Core 
2. How to create a IoT thing/device in AWS (aka RaspberryPi in our case)
3. How to send real-time device data securely to AWS IoT Core over MQTT protocol.
4. How to ingest device data in AWS Dynamo DB via IoT rule.

---

**Prerequisites:**
1. Raspberry Pi with Raspbian OS installed.
2. MicroSD card (16GB or more recommended).
4. Internet connectivity (Wi-Fi or Ethernet).
5. Basic knowledge of Python and Linux commands.
6. AWS Account setup with free credits.

---

**1. Introduction**

 AWS IoT core is a cloud managed service, which lets you connect to edge devices and makes it possible to develop applications that can act on the data generated by edge devices. It support a large volumne of messages and can route those messages to AWS services or other devices reliably and securely. One of the main aspects of AWS IoT code is the device communication and supports three main protocol: MQTT, HTTP, and websocket. In this lab, we will learn how to connect a thing aka device in IoT core, establish secure connection from raspberryPi over MQTT protocol and then ingest real-time data into a no-sql dynamodB database.

**2. Setup IoT Thing aka Device in IoT Core**

**Let us first create thing in AWS IoT core. Thing in IoT core means any edge device and in our case it would be a raspberryPi device. Head over to your AWS console and go to IoT Core. Please ensure you have configured your aws region to Singapore i.e., _ap-southeast-1_ (You can switch region from your console top right selecton).**

- **Part 1:** Within the IoT core console, go to Manage -> All Devices -> Things. Click on "Create things" and then select "_Create single thing_" (as we are only setting up one raspberryPi). Once done, click next. Please refer to below video for reference.
 
https://github.com/user-attachments/assets/7e295f39-d728-4b97-9358-fa0d2df21b5e

- **Part 2:** Enter "_Thing Name_" (You can keep any name you want). Also, you should create a thing type to group all raspberryPi devices into one. Once done, click next. Please refer to below video for reference.

https://github.com/user-attachments/assets/b78d9212-9613-4a52-bad0-6f70459cf56e

- **Part 3:** Do note to NOT use any special character like '#' in thing name. In the next screen, Please select "_Auto Generate a new Certificate_". Once done, click next. Please refer to below video for reference.

https://github.com/user-attachments/assets/ca08f3cd-ebf8-49f6-993c-31fcbd878573

- **Part 4:** Next, before finish creating "_Thing_", we need to create IoT policy to grant certain permissions to AWS IoT resources. For demonstration purpose, we are going to give permissions to all actions and resources (using wildcard operator '*') but in practice, you must only give those permissions, which are required. Please refer to below video for reference.

https://github.com/user-attachments/assets/2a012ca7-ffb2-4d44-b69a-df39f6491db3

- **Part 5:** Once Policy is created, click on "Create thing". This will create the "thing" for you and also generate set of security files for you to download. Please download following three files from the console and save in a folder onto your computer desktop:
  1. Device Certificate > Rename to aws-certificate.pem.crt
  2. Public Key File -> Rename to  aws-public.pem.key
  3. Private Key File -> Rename to aws-private.pem.key

https://github.com/user-attachments/assets/ac6a3ae7-f5c8-488d-a8cb-60963dc9b6b2

- **Part 6:** Once you have downloaded and saved all the three security files, click Done and you can now see the created "IoT Thing" under Manage -> All Devices -> Things. Next, go to Manage -> Security -> Certificates to view the certificate(s) IoT core created in previous step.

https://github.com/user-attachments/assets/df239ab3-1872-420e-b39a-50d2afb9535c

- **Part 7:** Next, we are going to attached certificate to our IoT Thing and already created IoT policy as shown below.

https://github.com/user-attachments/assets/243d44e6-4102-41e7-8554-3417703877a4

**3. Setup RaspberryPi to send any data over MQTT to IoT Core**

**In this section, we are going to use a simple python code to establish MQTT connection to AWS IoT Core and send some data to demonstrate.**

-  Set up and activate a virtual environment named "awsiotcore" for this experiment (to avoid conflicts in libraries) as below:
  
  ```bash
  sudo apt install python3-venv
  python3 -m venv awsiotcore
  source awsiotcore/bin/activate
  ```

-  Installing paho-mqtt and psutil:

  ```bash
  pip install paho-mqtt
  pip install --upgrade psutil
  ```

-  Next, Please download the files (.py and rootCA ) in [sample code](aws_iot_core) and save in same folder as the three security files. Your folder should look like as below screenshot:


   <img width="699" alt="Screenshot 2025-03-11 at 1 46 40â€¯PM" src="https://github.com/user-attachments/assets/5ffd875a-42c0-4226-b97a-00747131bd00" />


-  Now, we are ready to execute python file on RaspberryPi device. But, before that need to ensure entire folder is transferred to RaspberryPi device. You can use any filter transfer tool like winscp or using scp command in terminal like below to transfer entire aws_iot_core folder to your device. 

 ```bash
  scp -r aws_iot_core <rpihostname>@<rpi_IP_address>:/path/to/home
 ```

-  [Sample code](aws_iot_core/pipython.py) is used to connect establish MQTT connection. Ensure security file names mentioned in line 15 of this code matches with that of in your folder. Finally, paste your AWS IoT core endpoint in line 17. You can find endpoint in your IoT Core Consle under Connect -> Domain Configurations -> Domain Name.

  ```bash
   client.connect("xxxxxxxx-ats.iot.ap-southeast-1.amazonaws.com", 8883, 60) #Update this endpoint in Line 17
  ```

-  Now, we are ready to test real-time data ingestion from raspberryPi to IoT Core. To see the incoming data, go to Test -> MQTT Test Client and click on "Subcribe to a topic" and enter topic name "device/data" and click on "Subscribe". On raspberryPi terminal, run python file and observe the message received from IoT Thing aka raspberry device on IoT core MQTT console. Please refer to below video for reference.

https://github.com/user-attachments/assets/972ba843-ea5f-459a-8329-a68bf965b151

**4. Ingest Real-time Data into DynamodB via IoT Rule**

**In this section, we are going to ingest json data received from raspberryPi device into no SQL dynamodB database through message routing service in IoT rule.**

-  **Part 1:** First, we will comment line 24 in [Sample code](aws_iot_core/pipython.py) and add below json message to send cpu utilization number along with other fields (timestamp, quality, hostname) to MQTT topic.

  ```bash
    message = json.dumps({"time": int(time.time()),"quality": "GOOD","hostname": "rpiedge","value": psutil.cpu_percent()},indent=2)
  ```
- Next, we will repeat previous exercise to check data in MQQ test client with json data. Please refer to below video for reference.

https://github.com/user-attachments/assets/792485ab-2a0b-42e9-bb4a-db673a864e7e

- **Part 2:** Now, Let's create a rule in IoT core to ingest data. Go to Manage -> Message Routing -> Rules and Click "Create rule". Enter Rule name and SQL statement as shown in below video. Once Done, click Next.

https://github.com/user-attachments/assets/2b6c5536-6969-4546-8ae1-b7ec263ca471

- **Part 3:** Rule Actions allows to route incoming message from device to any destination like database, metric, notificattions etc. We will now create a dynamodB as an action to store the data generated and sent from raspberryPi device. On DynamodB console, type table name, primary key as hostname and sort key as timestamp. Please refer to below video for reference.

https://github.com/user-attachments/assets/b8654eaa-2d2a-4a5f-917b-3cfd3d8e4554

- **Part 4:** Come back to the Create Rule page and select the just created dynamodB table from dropdown menu. After that, we just need map the primary and sory key value of dynamodB table to that of from incming message payload. Please refer to below video for reference.

https://github.com/user-attachments/assets/d8ed05cb-082c-476e-b4c4-157e77fd82c2

- **Part 5:** Next, we need to either select an existing IAM role or create a new one which allows IoT core to ingest data into respective dynamodB table. For simplicity, we would just create a new one. Please refer to below video for reference.

https://github.com/user-attachments/assets/04e08ed8-8384-4550-ba7a-d049b7f55686

- **Part 6:** Click Next, review all the information and click "Create". In the Rules page, now you can see the just created rule and you can click again on rule name to view all the details. Please refer to below video for reference.

https://github.com/user-attachments/assets/b9622307-fa39-4e57-87bf-f286cd610a4f

- **Part 7:** Finally, we are now ready to ingest data into our dynamodB in real-time. Head over to DynamodB console and select the table. Then, start the python program [Sample code](aws_iot_core/pipython.py) on raspberryPi, wait for 5-10 seconds and then, refresh the dynamodB table and Hola!!! You will see the data coming in. 

https://github.com/user-attachments/assets/9aca4671-820a-4710-a195-7462e5911b36

**4. Optional Exercise**
- Try some real use-case edge analytics related to your project on raspberryPi and send processed data in real-time to IoT core in desired destination like a database or dashboard. For example, processed data from sensor(s) OR processed meta data from ML inference can be sent.

